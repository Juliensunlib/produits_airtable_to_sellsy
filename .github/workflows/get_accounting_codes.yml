name: RÃ©cupÃ©ration des codes comptables Sellsy

on:
  # ExÃ©cution manuelle uniquement
  workflow_dispatch:
    inputs:
      save_to_artifacts:
        description: 'Sauvegarder le fichier JSON en tant qu\'artefact'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  get-accounting-codes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v3

      - name: Configuration de Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Installation des dÃ©pendances
        run: |
          pip install -r requirements.txt

      - name: CrÃ©ation du fichier .env
        run: |
          echo "SELLSY_CONSUMER_TOKEN=${{ secrets.SELLSY_CONSUMER_TOKEN }}" >> .env
          echo "SELLSY_CONSUMER_SECRET=${{ secrets.SELLSY_CONSUMER_SECRET }}" >> .env
          echo "SELLSY_USER_TOKEN=${{ secrets.SELLSY_USER_TOKEN }}" >> .env
          echo "SELLSY_USER_SECRET=${{ secrets.SELLSY_USER_SECRET }}" >> .env

      - name: RÃ©cupÃ©ration des codes comptables
        id: get_codes
        run: |
          echo "==============================================="
          echo "  RÃ‰CUPÃ‰RATION DES CODES COMPTABLES SELLSY"
          echo "==============================================="
          python3 get_all_accounting_codes.py

          # Capturer le rÃ©sultat pour l'afficher dans le summary
          echo "âœ… Script exÃ©cutÃ© avec succÃ¨s" >> $GITHUB_STEP_SUMMARY

          # VÃ©rifier si le code 628000 a Ã©tÃ© trouvÃ©
          if grep -q "628000" accounting_codes_sellsy.json 2>/dev/null; then
            CODE_ID=$(grep -A 5 '"code": "628000"' accounting_codes_sellsy.json | grep '"id"' | head -1 | cut -d'"' -f4)
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ðŸŽ¯ Code comptable 628000 trouvÃ©!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ID trouvÃ©:** \`${CODE_ID}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“‹ Ã‰tapes suivantes:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Ouvrez le fichier \`config.py\` dans votre projet" >> $GITHUB_STEP_SUMMARY
            echo "2. Ajoutez cette ligne dans \`ACCOUNTING_CODE_MAPPING\`:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`python" >> $GITHUB_STEP_SUMMARY
            echo "ACCOUNTING_CODE_MAPPING = {" >> $GITHUB_STEP_SUMMARY
            echo "    '628000': '${CODE_ID}'," >> $GITHUB_STEP_SUMMARY
            echo "}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "3. DÃ©commentez les lignes 120-122 dans \`airtable_client.py\`" >> $GITHUB_STEP_SUMMARY
            echo "4. Commitez et pushez vos modifications" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âš ï¸ Code 628000 non trouvÃ©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "TÃ©lÃ©chargez l'artefact JSON pour voir tous les codes disponibles." >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: false

      - name: Affichage des 10 premiers codes
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š AperÃ§u des codes comptables" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Code | LibellÃ© | ID |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|-----|" >> $GITHUB_STEP_SUMMARY

          # Parser le JSON et afficher les 10 premiers codes
          python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          try:
              with open('accounting_codes_sellsy.json', 'r') as f:
                  codes = json.load(f)
                  count = 0
                  for code in codes[:10]:
                      if isinstance(code, dict):
                          code_num = code.get('code', 'N/A')
                          label = code.get('label', code.get('libelle', 'N/A'))
                          code_id = code.get('id', 'N/A')
                          # Tronquer le libellÃ© si trop long
                          if len(str(label)) > 40:
                              label = str(label)[:37] + "..."
                          print(f"| {code_num} | {label} | {code_id} |")
                          count += 1
              print(f"\n**Total:** {len(codes)} codes comptables rÃ©cupÃ©rÃ©s")
          except Exception as e:
              print(f"Erreur lors de la lecture du fichier: {e}")
          EOF

      - name: Sauvegarde du fichier JSON
        if: success() && github.event.inputs.save_to_artifacts == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: accounting-codes-sellsy
          path: accounting_codes_sellsy.json
          retention-days: 30

      - name: RÃ©sumÃ© final
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ TÃ©lÃ©charger le fichier complet" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Le fichier \`accounting_codes_sellsy.json\` contenant TOUS les codes comptables" >> $GITHUB_STEP_SUMMARY
          echo "est disponible dans les artefacts de ce workflow." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘‰ Cliquez sur **'accounting-codes-sellsy'** en haut de cette page pour le tÃ©lÃ©charger." >> $GITHUB_STEP_SUMMARY

      - name: Gestion des erreurs
        if: failure()
        run: |
          echo "âŒ Ã‰chec de la rÃ©cupÃ©ration des codes comptables" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” VÃ©rifications:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Les secrets GitHub sont-ils correctement configurÃ©s?" >> $GITHUB_STEP_SUMMARY
          echo "- Les clÃ©s API Sellsy sont-elles valides?" >> $GITHUB_STEP_SUMMARY
          echo "- Votre compte Sellsy a-t-il accÃ¨s Ã  l'API?" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Consultez les logs ci-dessus pour plus de dÃ©tails." >> $GITHUB_STEP_SUMMARY
